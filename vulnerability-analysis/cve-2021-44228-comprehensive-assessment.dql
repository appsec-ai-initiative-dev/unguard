// CVE-2021-44228 (Log4Shell) Comprehensive Vulnerability Assessment
// This query provides a complete assessment of the Log4Shell vulnerability exposure
// across all monitored process groups and related entities

fetch dt.entity.process_group
| fieldsAdd softwareTechnologies, runs_on
| expand softwareTechnologies
| filter contains(softwareTechnologies, "LOG4J")
| filter contains(softwareTechnologies, "version:2.0") or 
        contains(softwareTechnologies, "version:2.1") or 
        contains(softwareTechnologies, "version:2.2") or 
        contains(softwareTechnologies, "version:2.3") or 
        contains(softwareTechnologies, "version:2.4") or 
        contains(softwareTechnologies, "version:2.5") or 
        contains(softwareTechnologies, "version:2.6") or 
        contains(softwareTechnologies, "version:2.7") or 
        contains(softwareTechnologies, "version:2.8") or 
        contains(softwareTechnologies, "version:2.9") or 
        contains(softwareTechnologies, "version:2.10") or 
        contains(softwareTechnologies, "version:2.11") or 
        contains(softwareTechnologies, "version:2.12") or 
        contains(softwareTechnologies, "version:2.13") or 
        contains(softwareTechnologies, "version:2.14")
| summarize {
    vulnerable_process_groups = count(),
    affected_hosts = countDistinct(runs_on[dt.entity.host]),
    log4j_versions = collectDistinct(softwareTechnologies)
}