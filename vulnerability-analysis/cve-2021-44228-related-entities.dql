// CVE-2021-44228 (Log4Shell) Related Entities Analysis
// This query identifies related entities that could be impacted by the Log4Shell vulnerability
// including dependent services, applications, and infrastructure components

// Find hosts running vulnerable process groups
fetch dt.entity.host
| lookup [
    fetch dt.entity.process_group
    | fieldsAdd softwareTechnologies, runs_on
    | expand softwareTechnologies
    | filter contains(softwareTechnologies, "LOG4J")
    | filter contains(softwareTechnologies, "version:2.0") or 
            contains(softwareTechnologies, "version:2.1") or 
            contains(softwareTechnologies, "version:2.2") or 
            contains(softwareTechnologies, "version:2.3") or 
            contains(softwareTechnologies, "version:2.4") or 
            contains(softwareTechnologies, "version:2.5") or 
            contains(softwareTechnologies, "version:2.6") or 
            contains(softwareTechnologies, "version:2.7") or 
            contains(softwareTechnologies, "version:2.8") or 
            contains(softwareTechnologies, "version:2.9") or 
            contains(softwareTechnologies, "version:2.10") or 
            contains(softwareTechnologies, "version:2.11") or 
            contains(softwareTechnologies, "version:2.12") or 
            contains(softwareTechnologies, "version:2.13") or 
            contains(softwareTechnologies, "version:2.14")
    | fieldsAdd entity.name as pg_name, softwareTechnologies as pg_log4j_version, runs_on
  ], sourceField: id, lookupField: runs_on[dt.entity.host], prefix: "vulnerable_pg."
| filter isNotNull(vulnerable_pg.pg_name)
| fieldsAdd entity.name as host_name, osType, osVersion, vulnerable_pg.pg_name, vulnerable_pg.pg_log4j_version
| sort host_name